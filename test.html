<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="style/main.css">
    <link rel="stylesheet" href="style/header.css">
    <link rel="stylesheet" href="style/content.css">
    <link rel="stylesheet" href="style/footer.css">
    <link rel="stylesheet" href="style/font.css">
    <link rel="stylesheet" href="style/scrollbar.css">

    <script src="https://vk.com/js/api/openapi.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.1/handlebars.min.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="Choosefriends">Выберите друзей</div>
    </div>
    <div class="content">
        <div class="list">
            <div class="filter-block">
                <img src="zaLUPA.png" class="lupa">
                <input type="text" class="filter-name-input" placeholder="Начните вводить имя друга">
            </div>
            <div class="title">Ваши друзья</div>
            <div id="my_friends" class="friends">
            </div>
        </div>
        <div class="list">
            <div class="filter-block">
                <img src="zaLUPA.png" class="lupa">
                <input type="text" class="filter-name-input" placeholder="Начните вводить имя друга">
            </div>
            <div class="title">Друзья в списке</div>
            <div id="list_friends" class="friends">
            </div>
        </div>
    </div>
    <div class="footer">
        <button class="btnsave">Сохранить</button>
    </div>
</div>

<script src="first.js"></script>
<script src="model.js"></script>
<script src="View.js"></script>
<script src="Controller.js"></script>
<script>
    (function () {
        let isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
        let isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
        let scrollbarDiv = document.querySelector('.friends');
        if (!isChrome && !isSafari) {
            scrollbarDiv.innerHTML = 'You need Webkit browser to run this code';
        }
    })();

    const MyFriends = document.querySelector('#my_friends');
    const ListFriends = document.querySelector('#list_friends');
    let deletedl = [];
    let deletedr = [];
    Model.login(7135923, 2 | 8192)
        .then();
    Controoler.friends();
    const cont = document.querySelector('.content');
    cont.addEventListener('click', e => {
        let target = e.target;
        if (target.classList[0] === 'btndelete') {
            target.src = changeimg(target.src);
            let lastparent = target.parentNode;
            let destination;

            [MyFriends, ListFriends].forEach(element => {
                if (lastparent.parentNode !== element) {
                    destination = element;
                }
            });
            lastparent.parentNode.removeChild(lastparent);
            destination.appendChild(lastparent);
        }
    });

    function changeimg(image) {
        let result = '';
        ['krestik.png', 'plus.png'].forEach(img => {
            if (img !== image.split('/').pop()) {
                result = img;
            }
        });
        return result;
    }

    cont.addEventListener('keyup', e => {
        let target = e.target;
        if (target.tagName === 'INPUT') {
            let node = findfriendsnode(target);
            if (node.id === 'my_friends') {
                findfriend('friends', deletedl, node, target.value).then();
                removefriend(deletedl, node, target.value).then();
            } else if (node.id === 'list_friends') {
                findfriend('friends1', deletedr, node, target.value).then();
                removefriend(deletedr, node, target.value).then();
            }
        }
    });

    function findfriendsnode(node) {
        let result;
        while (node.classList[0] !== 'list') {
            node = node.parentNode;
        }
        node.childNodes.forEach(element => {
            if (element.tagName === 'DIV') {
                if (element.classList[0] === 'friends') {
                    result = element;
                }
            }
        });
        return result;
    }

    function findfriend(templ, deleted, listnode, part) {
        return new Promise((resolve, reject) => {
            for (let i = 0; i < deleted.length; i++) {
                let element = deleted[i];
                if (!isMatching(part, element.first_name, element.last_name)) {
                    listnode.innerHTML += View.render(templ, {list: [element]});
                    deleted.splice(deleted.indexOf(element), 1);
                    i--;
                }
            }
            resolve();
        });
    }

    function removefriend(deleted, listnode, part) {
        return new Promise((resolve, reject) => {
            let img;
            listnode.childNodes.forEach(friend => {
                if (friend.tagName === 'DIV') {
                    friend.childNodes.forEach(node => {
                        if (node.tagName === 'IMG') {
                            img = node.src;
                        }
                        if (node.tagName === 'DIV') {
                            [first_name, last_name] = node.innerHTML.split(' ');
                            console.log(`${part} ${first_name} ${last_name} ${isMatching(part, first_name, last_name)}`);
                            if (isMatching(part, first_name, last_name)) {
                                let newobj = {
                                    id: friend.getAttribute('friendid'),
                                    first_name: first_name,
                                    last_name: last_name,
                                    photo_100: img
                                };
                                deleted.push(newobj);
                                listnode.removeChild(friend);
                            }
                        }

                    });
                }
            });
            resolve();
        });
    }

    function isMatching(part, full1, full2) {
        return (full1.toLowerCase().indexOf(part.toLowerCase()) === -1) && (full2.toLowerCase().indexOf(part.toLowerCase()) === -1);
    }

    const footer = document.querySelector('.footer');
    footer.addEventListener('click', e => {

        if (e.target.tagName === 'BUTTON') {
            let tosave = [];
            ListFriends.childNodes.forEach(child => {
                if (child.tagName === 'DIV') {
                    tosave.push(Number(child.getAttribute('friendid')));
                }
            });
            localStorage.setItem('list', JSON.stringify(tosave));
        }
        alert("Сохранено!");
    });


    druganddrop([MyFriends, ListFriends]);

    function druganddrop(zones) {
        let current;

        zones.forEach(zone => {
            zone.addEventListener('dragstart', e => {
                current = {start: zone, element: e.target};
            });

            zone.addEventListener('dragover', e => {
                e.preventDefault();
            });

            zone.addEventListener('drop', e => {
                if (current) {
                    e.preventDefault();
                    if (zone !== current.start) {
                        current.element.childNodes.forEach(element => {
                            if (element.tagName === 'IMG') {
                                if (element.classList[0] === 'btndelete') {
                                    element.src = changeimg(element.src);
                                }
                            }
                        });
                    }
                    zone.appendChild(current.element);
                    current = null;
                }
            })
        })
    }


</script>

<script type="text/x-handlebars-templated" id="friends">
    {{#each list}}
    <div class="friend" draggable="true" friendid="{{id}}">
        <img src="{{photo_100}}" class="img-photo" draggable="false">
        <div class="fio">{{first_name}} {{last_name}}</div>
        <img src="plus.png" class="btndelete" draggable="false">
    </div>
    {{/each}}
</script>
<script type="text/x-handlebars-templated" id="friends1">
    {{#each list}}
    <div class="friend" draggable="true" friendid="{{id}}">
        <img src="{{photo_100}}" class="img-photo" draggable="false">
        <div class="fio">{{first_name}} {{last_name}}</div>
        <img src="krestik.png" class="btndelete" draggable="false">
    </div>
    {{/each}}
</script>
</body>
</html>